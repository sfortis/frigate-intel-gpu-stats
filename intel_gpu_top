#!/bin/bash
# Fake intel_gpu_top using fdinfo for accurate GPU stats on Alder Lake-N
# Uses cached snapshots - no sleep needed, fits within Frigate's 0.5s timeout
# Frigate calls: timeout 0.5s intel_gpu_top -J -o - -s 1000

CACHE=/tmp/.gpu_stats_cache

# Parse args (all ignored, just compatibility)
while [[ $# -gt 0 ]]; do
    case "$1" in
        -J) shift ;; -s) shift 2 ;; -o) shift 2 ;; -d) shift 2 ;; -l) shift ;;
        -h) echo "intel_gpu_top (fdinfo wrapper)"; exit 0 ;; *) shift ;;
    esac
done

# Find VAAPI ffmpeg PIDs
PIDS=$(ps aux 2>/dev/null | grep 'ffmpeg.*vaapi' | grep -v grep | awk '{print $2}')

if [ -z "$PIDS" ]; then
    echo '{"period":{"duration":1000.0,"unit":"ms"},"frequency":{"requested":750,"actual":200,"unit":"MHz"},"interrupts":{"count":0,"unit":"irq/s"},"rc6":{"value":99.0,"unit":"%"},"power":{"GPU":0.0,"Package":0.0,"unit":"W"},"engines":{"Render/3D/0":{"busy":0.0,"sema":0,"wait":0,"unit":"%"},"Blitter/0":{"busy":0.0,"sema":0,"wait":0,"unit":"%"},"Video/0":{"busy":0.0,"sema":0,"wait":0,"unit":"%"},"VideoEnhance/0":{"busy":0.0,"sema":0,"wait":0,"unit":"%"}}}'
    sleep 10
    exit 0
fi

# Current snapshot
NOW_NS=$(date +%s%N)
TOTAL_R=0; TOTAL_V=0
for pid in $PIDS; do
    r=$(cat /proc/$pid/fdinfo/4 2>/dev/null | awk '/drm-engine-render:/ {print $2}')
    v=$(cat /proc/$pid/fdinfo/4 2>/dev/null | awk '/drm-engine-video:/ {print $2}')
    TOTAL_R=$((TOTAL_R + ${r:-0}))
    TOTAL_V=$((TOTAL_V + ${v:-0}))
done

# Read previous snapshot
if [ -f "$CACHE" ]; then
    read PREV_NS PREV_R PREV_V < "$CACHE"
    DELTA_NS=$((NOW_NS - PREV_NS))

    if [ "$DELTA_NS" -gt 100000000 ]; then  # >100ms minimum
        DR=$((TOTAL_R - PREV_R))
        DV=$((TOTAL_V - PREV_V))
        [ "$DR" -lt 0 ] && DR=0
        [ "$DV" -lt 0 ] && DV=0
        RP=$(awk "BEGIN {printf \"%.2f\", $DR / $DELTA_NS * 100}")
        VP=$(awk "BEGIN {printf \"%.2f\", $DV / $DELTA_NS * 100}")
    else
        RP="0.00"; VP="0.00"
    fi
else
    RP="0.00"; VP="0.00"
fi

# Save current snapshot for next call
echo "$NOW_NS $TOTAL_R $TOTAL_V" > "$CACHE"

# Output JSON
echo "{\"period\":{\"duration\":1000.0,\"unit\":\"ms\"},\"frequency\":{\"requested\":750,\"actual\":750,\"unit\":\"MHz\"},\"interrupts\":{\"count\":0,\"unit\":\"irq/s\"},\"rc6\":{\"value\":0.0,\"unit\":\"%\"},\"power\":{\"GPU\":0.0,\"Package\":0.0,\"unit\":\"W\"},\"engines\":{\"Render/3D/0\":{\"busy\":${RP},\"sema\":0,\"wait\":0,\"unit\":\"%\"},\"Blitter/0\":{\"busy\":0.0,\"sema\":0,\"wait\":0,\"unit\":\"%\"},\"Video/0\":{\"busy\":${VP},\"sema\":0,\"wait\":0,\"unit\":\"%\"},\"VideoEnhance/0\":{\"busy\":0.0,\"sema\":0,\"wait\":0,\"unit\":\"%\"}}}"

# Keep running so timeout kills us with exit 124
sleep 10
